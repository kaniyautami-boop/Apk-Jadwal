<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clanvas - Aplikasi Penjadwalan Kelas</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Tailwind CSS & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SheetJS (XLSX) Library for Excel Import/Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --c-primary: #93c5fd; /* Soft Blue */
            --c-primary-light: #bfdbfe; /* Lighter Blue */
            --c-secondary: #fde047; /* Soft Yellow */
            --c-accent: #facc15; /* A bit darker Yellow */
            --c-bg: linear-gradient(135deg, #eff6ff 0%, #fefce8 100%); /* Soft Blue to Soft Yellow */
            --c-surface: rgba(255, 255, 255, 0.9);
            --c-text-dark: #1e293b; 
            --c-text-light: #64748b;
            --c-white: #ffffff;
            --c-border: #e2e8f0;
            --c-shadow: rgba(100, 116, 139, 0.08);
            --c-shadow-lg: rgba(100, 116, 139, 0.12);
        }

        html, body { height: 100%; overflow: hidden; }
        #app, .view { height: 100%; overflow-y: auto; overflow-x: hidden; background: var(--c-bg); }
        body { font-family: 'Poppins', sans-serif; color: var(--c-text-dark); }
        .view { display: none; }
        .view.active-view { display: block; animation: fadeIn 0.5s ease-in-out; }
        #landingView.active-view, #loginView.active-view, #introView.active-view, #classSelectionView.active-view { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .form-container { 
            background-color: var(--c-surface); 
            backdrop-filter: blur(16px); 
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 25px -5px var(--c-shadow-lg);
            border-radius: 1.5rem;
        }
        .main-tab-btn.active { 
            background-color: var(--c-primary); 
            color: var(--c-white); 
            font-weight: 700;
            box-shadow: 0 4px 15px var(--c-shadow-lg);
        }
        .fixed-modal { position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; padding: 1rem; }
        .fixed-modal.active { display: flex; animation: fadeInModal 0.3s ease-out; }
        @keyframes fadeInModal { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .elegant-title { text-shadow: 0px 3px 10px rgba(147, 197, 253, 0.5); }
        
        /* Butterfly Animation */
        .butterflies-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 0; }
        .butterfly { position: absolute; width: 20px; height: 20px; opacity: 0; animation: fly-around 15s linear infinite; }
        .butterfly::before, .butterfly::after { content: ''; position: absolute; width: 12px; height: 18px; background-color: var(--c-accent); border-radius: 50% 50% 0 50%; }
        .butterfly::before { left: 0; transform-origin: 0 100%; transform: rotate(20deg); animation: flutter-left 0.3s infinite alternate; }
        .butterfly::after { right: 0; background-color: var(--c-primary-light); transform-origin: 100% 100%; transform: rotate(-20deg); animation: flutter-right 0.3s infinite alternate; }
        @keyframes flutter-left { to { transform: rotate(45deg) scale(1.05); } }
        @keyframes flutter-right { to { transform: rotate(-45deg) scale(1.05); } }
        @keyframes fly-around { 0% { top: 110%; left: -10%; } 10% { opacity: 0.7; } 100% { top: -10%; left: 110%; } }
        .butterfly:nth-child(1) { animation-duration: 20s; animation-delay: 0s; transform: scale(0.8); }
        .butterfly:nth-child(2) { animation-duration: 17s; animation-delay: 3s; transform: scale(1); }
        .butterfly:nth-child(3) { animation-duration: 22s; animation-delay: 5s; transform: scale(0.9); }
        
        .toggle-switch { display: inline-block; position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--c-primary); }
        input:checked + .toggle-slider:before { transform: translateX(20px); }

        .mood-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .mood-calendar > div { aspect-ratio: 1/1; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .calendar-day { font-size: 0.8rem; color: var(--c-text-light); }

        /* Intro Animation */
        @keyframes intro-fade-in-out {
            0%, 100% { opacity: 0; transform: scale(0.9); }
            50% { opacity: 1; transform: scale(1); }
        }
        #introTitle {
            animation: intro-fade-in-out 2.5s ease-in-out forwards;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen">
        <div id="loadingSpinner" class="fixed inset-0 bg-white/70 z-50 flex-col items-center justify-center hidden"><div class="animate-spin rounded-full h-16 w-16 border-b-4 border-[var(--c-primary)]"></div><p class="mt-4 font-semibold">Memuat...</p></div>

        <div id="introView" class="view items-center justify-center p-4 overflow-hidden bg-white">
            <h1 id="introTitle" class="text-8xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-300">Clanvas</h1>
        </div>
        
        <div id="landingView" class="view items-center justify-center p-4 overflow-hidden relative">
            <div class="butterflies-container"><div class="butterfly"></div><div class="butterfly"></div><div class="butterfly"></div></div>
            <div class="text-center relative z-10">
                 <svg class="w-56 h-56 mx-auto" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <defs><filter id="soft-glow" x="-50%" y="-50%" width="200%" height="200%"><feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="var(--c-primary-light)" flood-opacity="0.8"/></filter></defs>
                    <g filter="url(#soft-glow)"><path d="M 25 160 C 40 175, 80 175, 100 160 L 100 40 C 80 25, 40 25, 25 40 Z" fill="var(--c-white)"/><path d="M 175 160 C 160 175, 120 175, 100 160 L 100 40 C 120 25, 160 25, 175 40 Z" fill="var(--c-white)"/><path d="M 100 42 L 100 158" stroke="#EAEAEA" stroke-width="2"/></g>
                    <g transform="translate(155 35) rotate(25) scale(0.5)"><path d="M 0 0 Q 25 -25 30 0 Q 10 20 0 0" fill="var(--c-accent)"/><path d="M 0 0 Q -25 -25 -30 0 Q -10 20 0 0" fill="var(--c-accent)"/><path d="M 0 0 Q 20 25 0 30 Q -15 20 0 0" fill="#fffbeb"/><path d="M 0 0 Q -20 25 0 30 Q 15 20 0 0" fill="#fffbeb"/><path d="M 0 -10 L 0 15" stroke="var(--c-secondary)" stroke-width="2.5" stroke-linecap="round"/></g>
                </svg>
                <h1 class="text-7xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-yellow-300 my-2 elegant-title">Clanvas</h1>
                <p class="max-w-xl mx-auto mt-4 text-center" style="color: var(--c-text-light);">Jelajahi hari sekolahmu dengan mudah. Atur semua jadwal kelasmu di satu tempat. Praktis, mudah, dan efisien.</p>
                <div class="mt-10 flex justify-center"><button id="goToLoginBtn" class="font-semibold py-3 px-10 rounded-full shadow-lg transition-all transform hover:scale-105 bg-gradient-to-r from-blue-400 to-sky-400 text-white">Masuk</button></div>
            </div>
        </div>
       
        <div id="loginView" class="view items-center justify-center p-4"><div class="w-full max-w-md"><div class="form-container p-8"><h2 class="text-3xl font-bold text-center mb-2">Selamat Datang</h2><p class="text-center mb-6" style="color: var(--c-text-light);">Silakan masuk untuk melanjutkan</p><form id="authForm"><div class="mb-4"><label for="fullName" class="block text-sm font-medium mb-1" style="color: var(--c-text-light);">Nama Lengkap</label><input type="text" id="fullName" class="w-full px-4 py-2 border rounded-lg focus:ring-2 bg-white/50" style="--tw-ring-color: var(--c-primary-light);" required></div><div class="mb-4"><label for="password" class="block text-sm font-medium mb-1" style="color: var(--c-text-light);">Password</label><input type="password" id="password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 bg-white/50" style="--tw-ring-color: var(--c-primary-light);" required></div><div class="mb-4"><label for="loginRole" class="block text-sm font-medium mb-1" style="color: var(--c-text-light);">Masuk sebagai</label><select id="loginRole" class="w-full px-4 py-2 border rounded-lg bg-white/50"><option value="Siswa">Siswa</option><option value="Admin">Admin</option></select></div><div id="loginGradeContainer" class="mb-4"><label for="loginGrade" class="block text-sm font-medium mb-1" style="color: var(--c-text-light);">Tingkat Kelas</label><select id="loginGrade" class="w-full px-4 py-2 border rounded-lg bg-white/50"><option value="10">10</option><option value="11">11</option><option value="12">12</option></select></div><button type="submit" class="w-full text-white font-bold py-3 px-4 rounded-lg transition bg-gradient-to-r from-blue-500 to-sky-500 hover:from-blue-600 hover:to-sky-600">Masuk</button></form></div><button id="backToLandingBtn" class="mt-4 flex items-center gap-2 mx-auto" style="color: var(--c-text-light);"><i class="fas fa-arrow-left"></i> Kembali</button></div></div>
       
        <div id="classSelectionView" class="view"></div>
        <div id="adminDashboardView" class="view"></div>
        <div id="studentDashboardView" class="view"></div>
    </div>
   
    <!-- Hidden File Input for Excel Upload -->
    <input type="file" id="excelUploadInput" accept=".xlsx, .xls" class="hidden">

    <!-- MODAL-MODAL -->
    <div id="scheduleEditModal" class="fixed-modal"><div class="bg-white rounded-2xl shadow-xl w-full max-w-5xl p-6 max-h-[90vh] flex flex-col"><h3 id="scheduleModalTitle" class="text-xl font-bold mb-4 text-center"></h3><div class="flex-grow overflow-y-auto pr-2 -mr-2"><div class="mb-6"><h4 class="font-bold text-lg mb-2 border-b pb-1">Jadwal Pelajaran</h4><div id="lessonScheduleFormContainer" class="space-y-2"></div><button type="button" id="addLessonBtn" class="mt-3 text-sm text-white py-1 px-3 rounded-md bg-blue-500 hover:bg-blue-600">+ Tambah Pelajaran</button></div><div class="mb-6"><h4 class="font-bold text-lg mb-2 border-b pb-1">Jadwal Piket</h4><div id="picketScheduleFormContainer" class="space-y-2"></div><button type="button" id="addPicketBtn" class="mt-3 text-sm text-white py-1 px-3 rounded-md bg-blue-500 hover:bg-blue-600">+ Tambah Hari Piket</button></div><div><h4 class="font-bold text-lg mb-2 border-b pb-1">Organigram & Wali Kelas</h4><div id="organigramFormContainer" class="space-y-3"></div></div></div><div class="mt-6 flex justify-end gap-2 border-t pt-4"><button type="button" class="modal-close-btn bg-slate-200 py-2 px-4 rounded-md">Tutup</button><button type="button" id="saveScheduleChangesBtn" class="text-white py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600">Simpan Semua Perubahan</button></div></div></div>
    <div id="confirmModal" class="fixed-modal"><div class="bg-white rounded-2xl shadow-xl w-full max-w-sm p-6 text-center"><h3 id="confirmTitle" class="text-lg font-bold mb-2">Konfirmasi Tindakan</h3><p id="confirmText" class="text-slate-600 mb-6"></p><div class="flex justify-center gap-4"><button id="cancelDeleteBtn" class="bg-slate-200 py-2 px-6 rounded-md">Batal</button><button id="confirmDeleteBtn" class="bg-red-500 text-white py-2 px-6 rounded-md">Hapus</button></div></div></div>
    <div id="userAddModal" class="fixed-modal"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6"><h3 class="text-xl font-bold mb-4">Tambah Pengguna Baru</h3><form id="userAddForm"><div class="mb-4"><label for="newFullName" class="block text-sm font-medium">Nama Lengkap</label><input type="text" id="newFullName" class="w-full mt-1 p-2 border rounded-md" required></div><div class="mb-4"><label for="newPassword" class="block text-sm font-medium">Password</label><input type="password" id="newPassword" class="w-full mt-1 p-2 border rounded-md" required></div><div class="mb-4"><label for="newRole" class="block text-sm font-medium">Peran</label><select id="newRole" class="w-full mt-1 p-2 border rounded-md"><option value="Siswa" selected>Siswa</option><option value="Admin">Admin</option></select></div><div id="newUserGradeContainer" class="mb-4"><label for="newGrade" class="block text-sm font-medium">Tingkat Kelas</label><select id="newGrade" class="w-full mt-1 p-2 border rounded-md"><option value="10">10</option><option value="11">11</option><option value="12">12</option></select></div><div class="mt-6 flex justify-end gap-2"><button type="button" class="modal-close-btn bg-slate-200 py-2 px-4 rounded-md">Batal</button><button type="submit" class="text-white py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600">Tambah</button></div></form></div></div>
    <div id="userEditModal" class="fixed-modal"><div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6"><h3 class="text-xl font-bold mb-4">Edit Pengguna</h3><form id="userEditForm"><input type="hidden" id="editUserId"><div class="mb-4"><label for="editFullName" class="block text-sm font-medium">Nama Lengkap</label><input type="text" id="editFullName" class="w-full mt-1 p-2 border rounded-md" required></div><div class="mb-4"><label for="editPassword" class="block text-sm font-medium">Password (kosongkan jika tidak diubah)</label><input type="password" id="editPassword" class="w-full mt-1 p-2 border rounded-md"></div><div class="mb-4"><label for="editRole" class="block text-sm font-medium">Peran</label><select id="editRole" class="w-full mt-1 p-2 border rounded-md"><option value="Siswa">Siswa</option><option value="Admin">Admin</option></select></div><div id="editUserGradeContainer" class="mb-4"><label for="editGrade" class_alias="block text-sm font-medium">Tingkat Kelas</label><select id="editGrade" class="w-full mt-1 p-2 border rounded-md"><option value="10">10</option><option value="11">11</option><option value="12">12</option></select></div><div class="mt-6 flex justify-end gap-2"><button type="button" class="modal-close-btn bg-slate-200 py-2 px-4 rounded-md">Batal</button><button type="submit" class="text-white py-2 px-4 rounded-md bg-blue-500 hover:bg-blue-600">Simpan Perubahan</button></div></form></div></div>
    <div id="alertBox" class="fixed top-5 right-5 z-50 bg-red-500 text-white py-2 px-4 rounded-lg shadow-md hidden"><p id="alertText"></p></div>

    <script type="module">
        // --- KONFIGURASI SUPABASE ---
        // PENTING: Kunci di bawah ini adalah untuk proyek demo publik dan dapat direset.
        // Untuk menyimpan data Anda secara permanen, GANTI DUA BARIS DI BAWAH INI
        // dengan URL & Kunci dari dasbor Supabase Anda sendiri.
        const SUPABASE_URL = 'https://wjnmbgzohqdoogjqvyyj.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indqbm1iZ3pvaHFkb29nanF2eXlqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MDU4MTEsImV4cCI6MjA3NTk4MTgxMX0.xvqWcRpXmEagG-f-TZcSub0RT9tDsyvaYeuGJ09_soo';
        
        // Cek jika URL dan Kunci adalah placeholder (tetap ada untuk keamanan)
        if (SUPABASE_URL === 'GANTI_DENGAN_URL_PROYEK_ANDA' || SUPABASE_ANON_KEY === 'GANTI_DENGAN_KUNCI_ANON_ANDA') {
            document.body.innerHTML = `<div class="p-8 text-center bg-red-100 text-red-800">
                <h1 class="text-2xl font-bold">Kesalahan Konfigurasi</h1>
                <p class="mt-4">Harap masukkan URL Proyek dan Kunci Anon Supabase Anda di dalam file HTML.</p>
                <p>Ikuti panduan yang telah diberikan untuk mendapatkan informasi ini dari dasbor Supabase Anda.</p>
            </div>`;
            throw new Error("Supabase URL and Key not configured.");
        }
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- GLOBAL STATE ---
        let currentUserProfile = null;
        let itemToDelete = { type: null, id: null, name: null };
        let allUsers = [];
        let allClasses = [];
        let miniNotes = {};
        let moodLogs = [];
        let currentEditingClassId = null;
        let notificationInterval = null;
        let studentChartInstance = null;
        let adminChartInstance = null;
        
        const allDays = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat"];
        const SESSION_KEY = 'classScheduleAppSession_v5';

        const views = { intro: document.getElementById('introView'), landing: document.getElementById('landingView'), login: document.getElementById('loginView'), classSelection: document.getElementById('classSelectionView'), studentDashboard: document.getElementById('studentDashboardView'), adminDashboard: document.getElementById('adminDashboardView') };
        const modals = { schedule: document.getElementById('scheduleEditModal'), confirm: document.getElementById('confirmModal'), userAdd: document.getElementById('userAddModal'), userEdit: document.getElementById('userEditModal') };
        const loadingSpinner = document.getElementById('loadingSpinner');

        const showView = (id) => { Object.values(views).forEach(v => v.classList.remove('active-view')); if(views[id]) views[id].classList.add('active-view'); };
        const showModal = (id) => { if(modals[id]) modals[id].classList.add('active'); };
        const closeModal = () => Object.values(modals).forEach(m => m.classList.remove('active'));
        const showLoading = (show) => { loadingSpinner.style.display = show ? 'flex' : 'none'; };
        const showAlert = (message, isError = true) => { const el = document.getElementById('alertBox'); el.querySelector('p').textContent = message; el.className = `fixed top-5 right-5 z-50 text-white py-2 px-4 rounded-lg shadow-md ${isError ? 'bg-red-500' : 'bg-green-500'}`; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 4000); };

        async function initializeDB() {
            showLoading(true);
            try {
                const { data: users, error: usersError } = await supabase.from('users').select('*');
                if (usersError) throw usersError;

                if (users && users.length === 0) {
                    // Database kosong, isi dengan data awal
                    const initialUsers = [
                        { id: 'admin1', full_name: 'Admin Sekolah', password: 'admin', role: 'Admin', grade: null, selected_class_id: null, notifications_enabled: false },
                        { id: 'siswa1', full_name: 'Siswa Contoh', password: 'siswa', role: 'Siswa', grade: '10', selected_class_id: null, notifications_enabled: true }
                    ];
                    const { error: insertUserError } = await supabase.from('users').insert(initialUsers);
                    if (insertUserError) throw insertUserError;

                    const generatedClasses = [];
                    const grades = ['10', '11', '12'];
                    const letters = 'ABCDEFGHIJKL'.split('');
                    grades.forEach(grade => letters.forEach(letter => {
                        const className = `${grade}${letter}`;
                        generatedClasses.push({ id: `class_${className}`, name: className, grade: grade, lessons: [], picket: [], organigram: { waliKelas: '', ketuaKelas: '', wakilKetua: '', sekertaris: '', bendahara: '', anggotaKelas: [] } });
                    }));
                    const { error: insertClassError } = await supabase.from('classes').insert(generatedClasses);
                    if (insertClassError) throw insertClassError;
                    
                    const { error: insertNoteError } = await supabase.from('mini_notes').insert([{id: 1, quote: 'Pendidikan adalah senjata paling ampuh.', announcement: 'Selamat datang!'}]);
                    if (insertNoteError) throw insertNoteError;
                }
            } catch(error) {
                console.error("Error during DB initialization:", error);
                showAlert("Gagal menginisialisasi database.");
            } finally {
                showLoading(false);
            }
        }

        async function loadDataFromDB() {
            showLoading(true);
            try {
                const { data: usersData, error: usersError } = await supabase.from('users').select('*');
                if (usersError) throw usersError;
                allUsers = usersData || [];

                const { data: classesData, error: classesError } = await supabase.from('classes').select('*');
                if (classesError) throw classesError;
                allClasses = classesData || [];

                const { data: miniNotesData, error: miniNotesError } = await supabase.from('mini_notes').select('*').limit(1);
                if (miniNotesError) throw miniNotesError;
                miniNotes = (miniNotesData && miniNotesData.length > 0) ? miniNotesData[0] : {};

                // Muat log mood berdasarkan peran pengguna
                moodLogs = [];
                if (currentUserProfile) {
                    if (currentUserProfile.role === 'Siswa') {
                        const { data: moodLogsData, error: moodLogsError } = await supabase.from('mood_logs').select('*').eq('userId', currentUserProfile.id);
                        if (moodLogsError) throw moodLogsError;
                        moodLogs = moodLogsData || [];
                    } else if (currentUserProfile.role === 'Admin') {
                        // Admin memuat semua log untuk rekap
                        const { data: moodLogsData, error: moodLogsError } = await supabase.from('mood_logs').select('*');
                        if (moodLogsError) throw moodLogsError;
                        moodLogs = moodLogsData || [];
                    }
                }
            } catch (error) {
                console.error("Error loading data:", error);
                showAlert(`Gagal memuat data: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }
        
        function handleLogout() {
            sessionStorage.removeItem(SESSION_KEY);
            currentUserProfile = null;
            if (notificationInterval) clearInterval(notificationInterval);
            if (studentChartInstance) studentChartInstance.destroy();
            if (adminChartInstance) adminChartInstance.destroy();
            showView('landing');
        }

        async function navigateBasedOnRole() {
            if (!currentUserProfile) {
                showView('login');
                return;
            }
            await loadDataFromDB();
            if (currentUserProfile.role === 'Admin') {
                renderAdminDashboard();
                showView('adminDashboard');
            } else if (currentUserProfile.role === 'Siswa') {
                if (currentUserProfile.selected_class_id) {
                    renderStudentDashboard(currentUserProfile.selected_class_id);
                    showView('studentDashboard');
                } else {
                    renderClassSelection();
                    showView('classSelection');
                }
            }
        }
        
        function renderAdminDashboard() {
           views.adminDashboard.innerHTML = `
                <div class="p-4 sm:p-8">
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h1 class="text-3xl font-bold">Dasbor Admin</h1>
                            <p class="text-slate-500">Selamat datang, ${currentUserProfile.full_name}!</p>
                        </div>
                        <button id="adminLogoutBtn" class="bg-red-500 text-white py-2 px-4 rounded-lg font-semibold hover:bg-red-600 transition-colors">Keluar</button>
                    </header>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- User Management -->
                        <div class="form-container p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Manajemen Pengguna</h2>
                                <button id="addUserBtn" class="bg-blue-500 text-white py-1 px-3 rounded-md text-sm font-semibold hover:bg-blue-600">+ Tambah</button>
                            </div>
                            <div id="userList" class="max-h-96 overflow-y-auto space-y-2 pr-2"></div>
                        </div>

                        <!-- Class Management -->
                        <div class="form-container p-6">
                             <h2 class="text-xl font-bold mb-4">Manajemen Kelas</h2>
                             <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 text-center" id="classListAdmin"></div>
                             <div class="border-t mt-6 pt-4 flex flex-col sm:flex-row gap-2">
                                <button id="downloadTemplateBtn" class="flex-1 text-sm bg-green-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-green-700 transition">
                                    <i class="fas fa-download mr-2"></i>Unduh Template Excel
                                </button>
                                <button id="uploadExcelBtn" class="flex-1 text-sm bg-blue-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-blue-700 transition">
                                    <i class="fas fa-upload mr-2"></i>Impor Jadwal dari Excel
                                </button>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Mood Recap -->
                    <div class="form-container p-6 mt-8">
                        <h2 class="text-xl font-bold mb-4">Rekap Jurnal Mood Siswa</h2>
                        <div class="mb-4">
                            <label for="moodRecapFilter" class="block text-sm font-medium mb-1">Filter per Kelas:</label>
                            <select id="moodRecapFilter" class="w-full p-2 border rounded-md bg-white">
                                <option value="all">Semua Siswa</option>
                                ${allClasses.sort((a,b) => a.name.localeCompare(b.name)).map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        <div style="height: 300px;"><canvas id="adminMoodChart"></canvas></div>
                    </div>
                </div>
            `;
            renderUserList();
            renderClassListForAdmin();
            drawAdminMoodChart('all');
        }

        function renderUserList() {
            const container = document.getElementById('userList');
            if (!container) return;
            if (!Array.isArray(allUsers)) {
                console.error("Data pengguna tidak valid:", allUsers);
                container.innerHTML = `<p class="text-red-500">Gagal memuat data pengguna.</p>`;
                return;
            }
            container.innerHTML = allUsers.map(user => `
                <div class="flex items-center justify-between p-2 rounded-md bg-slate-50">
                    <div>
                        <p class="font-semibold">${user.full_name}</p>
                        <p class="text-xs text-slate-500">${user.role} ${user.grade ? `- Tingkat ${user.grade}` : ''}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-user-btn" data-id="${user.id}"><i class="fas fa-edit text-blue-500"></i></button>
                        ${user.id !== 'admin1' ? `<button class="delete-user-btn" data-id="${user.id}" data-name="${user.full_name}"><i class="fas fa-trash text-red-500"></i></button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderClassListForAdmin() {
            const container = document.getElementById('classListAdmin');
            if (!container) return;
            container.innerHTML = allClasses.sort((a,b) => a.name.localeCompare(b.name)).map(cls => `
                <button class="edit-class-btn p-3 bg-slate-100 rounded-lg font-semibold hover:bg-[var(--c-primary-light)] transition" data-id="${cls.id}">
                    ${cls.name}
                </button>
            `).join('');
        }

        function renderStudentDashboard(classId) {
            const cls = allClasses.find(c => c.id === classId);
            if (!cls) { showAlert('Kelas tidak ditemukan.'); handleLogout(); return; }
            const fullDate = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            views.studentDashboard.innerHTML = `<div class="max-w-7xl mx-auto p-4 md:p-8"><header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"><div><h2 class="text-3xl font-bold">Selamat Datang, ${currentUserProfile.full_name}!</h2><p class="text-xl font-semibold mt-2" style="color: var(--c-text-light);">Kelas ${cls.name}</p><p class="text-sm font-medium text-slate-400">${fullDate}</p></div><div class="flex items-center gap-4"><div class="text-sm flex items-center gap-2"><label for="notifToggle">Notifikasi</label><label class="toggle-switch"><input type="checkbox" id="notifToggle" ${currentUserProfile.notifications_enabled ? 'checked' : ''}><span class="toggle-slider" style="background-color: ${currentUserProfile.notifications_enabled ? 'var(--c-primary)' : '#ccc'};"></span></label></div><button class="changeClassBtn text-sm font-semibold py-2 px-4 rounded-lg bg-white border border-yellow-500 text-yellow-600">Ganti Kelas</button><button class="logoutBtn text-sm text-white font-semibold py-2 px-4 rounded-lg bg-blue-500 hover:bg-blue-600">Logout</button></div></header><div class="mb-6 grid grid-cols-2 md:grid-cols-4 gap-3" id="mainTabContainer"><button class="main-tab-btn p-4 bg-white rounded-lg shadow-md font-semibold active" data-tab="jadwalPelajaran">Jadwal Pelajaran</button><button class="main-tab-btn p-4 bg-white rounded-lg shadow-md font-semibold" data-tab="jadwalPiket">Jadwal Piket</button><button class="main-tab-btn p-4 bg-white rounded-lg shadow-md font-semibold" data-tab="organigram">Organigram</button><button class="main-tab-btn p-4 bg-white rounded-lg shadow-md font-semibold" data-tab="jurnalMood">Jurnal Mood</button></div><div id="tabContentContainer">${renderStudentTabContent(cls, 'jadwalPelajaran')}</div><div class="mt-6 bg-white p-4 rounded-2xl shadow-md"><h3 class="font-bold text-lg mb-2">Mini Notes</h3><div class="p-3 rounded-lg mb-2 bg-yellow-100"><p class="text-sm font-semibold">Quote Hari Ini:</p><p class="text-sm italic">"${miniNotes.quote||''}"</p></div><div class="p-3 rounded-lg bg-blue-100"><p class="text-sm font-semibold">Pengumuman:</p><p class="text-sm">${miniNotes.announcement||''}</p></div></div></div>`;
        }
        
        const moodConfig = {
            senang: { emoji: 'ðŸ˜„', color: 'bg-green-100', text: 'Senang', chartColor: '#4ade80' },
            biasa: { emoji: 'ðŸ™‚', color: 'bg-blue-100', text: 'Biasa Saja', chartColor: '#60a5fa' },
            sedih: { emoji: 'ðŸ˜¢', color: 'bg-slate-200', text: 'Sedih', chartColor: '#94a3b8' },
            semangat: { emoji: 'ðŸ”¥', color: 'bg-orange-100', text: 'Bersemangat', chartColor: '#fb923c' },
            lelah: { emoji: 'ðŸ˜´', color: 'bg-purple-100', text: 'Lelah', chartColor: '#a78bfa' },
        };

        function renderMoodJournal() {
            const today = new Date();
            const monthName = today.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            
            let moodButtonsHtml = Object.entries(moodConfig).map(([key, value]) => `
                <button class="mood-btn flex flex-col items-center gap-1 p-2 rounded-lg hover:bg-slate-100 transition" data-mood="${key}">
                    <span class="text-3xl">${value.emoji}</span>
                    <span class="text-xs font-medium">${value.text}</span>
                </button>
            `).join('');

            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-xl mb-4">Bagaimana Perasaanmu Hari Ini?</h3>
                    <div class="flex justify-around items-center mb-6">${moodButtonsHtml}</div>
                    <div class="border-t pt-4">
                        <h4 class="font-bold text-lg mb-4 text-center">${monthName}</h4>
                        <div class="grid grid-cols-7 gap-1 text-center font-semibold text-sm mb-2">
                            <div>Min</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div>
                        </div>
                        <div class="mood-calendar">${createMoodCalendar()}</div>
                    </div>
                    <div class="mt-8 border-t pt-6">
                        <h4 class="font-bold text-lg mb-4 text-center">Rekap Mood Bulan Ini</h4>
                        <div class="max-w-xs mx-auto">
                            <canvas id="studentMoodChart"></canvas>
                        </div>
                    </div>
                </div>
            `;
        }

        function createMoodCalendar() {
            const now = new Date();
            const date = new Date(now.getFullYear(), now.getMonth(), 1);
            const daysInMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
            const firstDayIndex = date.getDay(); 

            let calendarHtml = '';
            for (let i = 0; i < firstDayIndex; i++) { calendarHtml += `<div></div>`; }

            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(now.getFullYear(), now.getMonth(), day);
                const dateString = currentDate.toISOString().split('T')[0];
                const moodLog = moodLogs.find(log => log.date === dateString && log.userId === currentUserProfile.id);
                
                let dayClass = 'calendar-day';
                let content = day;
                
                if (moodLog && moodConfig[moodLog.mood]) {
                    dayClass += ` ${moodConfig[moodLog.mood].color}`;
                    content = moodConfig[moodLog.mood].emoji;
                }
                
                if (day === now.getDate() && now.getMonth() === date.getMonth()) {
                     dayClass += ' ring-2 ring-blue-400';
                }

                calendarHtml += `<div class="${dayClass}">${content}</div>`;
            }
            return calendarHtml;
        }

        function drawStudentMoodChart() {
            if (studentChartInstance) studentChartInstance.destroy();
            const ctx = document.getElementById('studentMoodChart')?.getContext('2d');
            if (!ctx) return;

            const now = new Date();
            const currentMonthLogs = moodLogs.filter(log => {
                const logDate = new Date(log.date);
                return log.userId === currentUserProfile.id &&
                       logDate.getMonth() === now.getMonth() &&
                       logDate.getFullYear() === now.getFullYear();
            });

            const moodCounts = {};
            Object.keys(moodConfig).forEach(key => moodCounts[key] = 0); // Initialize

            currentMonthLogs.forEach(log => {
                if (moodCounts.hasOwnProperty(log.mood)) {
                    moodCounts[log.mood]++;
                }
            });

            studentChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.values(moodConfig).map(v => v.text),
                    datasets: [{
                        data: Object.keys(moodConfig).map(key => moodCounts[key]),
                        backgroundColor: Object.values(moodConfig).map(v => v.chartColor),
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { 
                            position: 'bottom',
                            labels: { padding: 10 }
                        } 
                    } 
                }
            });
        }
        
        function drawAdminMoodChart(classId) {
            if (adminChartInstance) adminChartInstance.destroy();
            const ctx = document.getElementById('adminMoodChart')?.getContext('2d');
            if (!ctx) return;

            // 1. Dapatkan ID pengguna yang relevan
            let userIdsToInclude = [];
            if (classId === 'all') {
                userIdsToInclude = allUsers.filter(u => u.role === 'Siswa').map(u => u.id);
            } else {
                userIdsToInclude = allUsers.filter(u => u.selected_class_id === classId).map(u => u.id);
            }

            // 2. Filter log
            const relevantLogs = moodLogs.filter(log => userIdsToInclude.includes(log.userId));

            // 3. Agregat data
            const moodCounts = {};
            Object.keys(moodConfig).forEach(key => moodCounts[key] = 0); // Initialize

            relevantLogs.forEach(log => {
                if (moodCounts.hasOwnProperty(log.mood)) {
                    moodCounts[log.mood]++;
                }
            });

            // 4. Render chart
            adminChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.values(moodConfig).map(v => v.text),
                    datasets: [{
                        label: 'Jumlah Catatan',
                        data: Object.keys(moodConfig).map(key => moodCounts[key]),
                        backgroundColor: Object.values(moodConfig).map(v => v.chartColor),
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false } 
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // Hanya tampilkan angka bulat
                            }
                        }
                    }
                }
            });
        }


        function renderStudentTabContent(cls, activeTab) {
            if (activeTab === 'jadwalPelajaran') {
                if (!cls.lessons || cls.lessons.length === 0) {
                    return `<div class="text-center p-8 bg-white rounded-lg shadow-md"><i class="fas fa-calendar-times text-4xl text-slate-300 mb-4"></i><h3 class="font-bold text-xl">Jadwal Pelajaran Belum Dibuat</h3><p class="text-slate-500">Admin belum mengatur jadwal pelajaran untuk kelas ini.</p></div>`;
                }
                let tableHtml = '<div class="bg-white rounded-lg shadow-md overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-50"><tr><th class="p-3">Hari</th><th class="p-3">Waktu</th><th class="p-3">Mata Pelajaran</th><th class="p-3">Guru</th></tr></thead><tbody>';
                allDays.forEach(day => {
                    const lessonsForDay = cls.lessons.filter(l => l.day === day).sort((a,b) => a.time.localeCompare(b.time));
                    if (lessonsForDay.length > 0) {
                        lessonsForDay.forEach((lesson, index) => {
                            tableHtml += `<tr class="border-b">`;
                            if (index === 0) { tableHtml += `<td class="p-3 font-semibold align-top" rowspan="${lessonsForDay.length}">${day}</td>`; }
                            tableHtml += `<td class="p-3 whitespace-nowrap">${lesson.time}</td><td class="p-3 font-medium">${lesson.subject}</td><td class="p-3">${lesson.teacher}</td></tr>`;
                        });
                    } else {
                        tableHtml += `<tr class="border-b"><td class="p-3 font-semibold">${day}</td><td colspan="3" class="p-3 text-slate-400">Tidak ada jadwal</td></tr>`;
                    }
                });
                return tableHtml + '</tbody></table></div>';
            }
            if (activeTab === 'jadwalPiket') {
                if (!cls.picket || cls.picket.length === 0) {
                     return `<div class="text-center p-8 bg-white rounded-lg shadow-md"><i class="fas fa-broom text-4xl text-slate-300 mb-4"></i><h3 class="font-bold text-xl">Jadwal Piket Belum Dibuat</h3><p class="text-slate-500">Admin belum mengatur jadwal piket untuk kelas ini.</p></div>`;
                }
                let picketHtml = '<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">';
                allDays.forEach(day => {
                    const picketForDay = cls.picket.find(p => p.day === day);
                    picketHtml += `<div class="bg-white rounded-lg shadow p-4"><h4 class="font-bold text-lg mb-2">${day}</h4>`;
                    if (picketForDay && picketForDay.students && picketForDay.students.length > 0) {
                        picketHtml += '<ul class="list-disc list-inside text-slate-600">';
                        picketForDay.students.forEach(student => { picketHtml += `<li>${student}</li>`; });
                        picketHtml += '</ul>';
                    } else {
                        picketHtml += '<p class="text-sm text-slate-400">Tidak ada jadwal piket</p>';
                    }
                    picketHtml += '</div>';
                });
                return picketHtml + '</div>';
            }
            if (activeTab === 'organigram') {
                const org = cls.organigram || {};
                const waliKelas = org.waliKelas || 'Belum diatur';
                const ketuaKelas = org.ketuaKelas || org.ketuaMurid || 'Belum diatur'; // Handle old field
                const wakilKetua = org.wakilKetua || 'Belum diatur';
                const sekertaris = org.sekertaris || 'Belum diatur';
                const bendahara = org.bendahara || 'Belum diatur';
                const anggotaKelas = org.anggotaKelas || [];

                let anggotaHtml = '<p class="text-sm text-slate-400">Belum ada anggota</p>';
                if (anggotaKelas.length > 0) {
                    anggotaHtml = '<ul class="list-disc list-inside text-slate-600 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-1">';
                    anggotaKelas.forEach(nama => { anggotaHtml += `<li>${nama}</li>`; });
                    anggotaHtml += '</ul>';
                }

                return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="font-bold text-2xl mb-6 text-center">Struktur Kelas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-center mb-6">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <p class="text-sm font-semibold text-blue-800">Wali Kelas</p>
                            <p class="text-xl font-bold">${waliKelas}</p>
                        </div>
                        <div class="bg-yellow-50 p-4 rounded-lg">
                            <p class="text-sm font-semibold text-yellow-800">Ketua Kelas</p>
                            <p class="text-xl font-bold">${ketuaKelas}</p>
                        </div>
                        <div class="bg-green-50 p-4 rounded-lg">
                            <p class="text-sm font-semibold text-green-800">Wakil Ketua Kelas</p>
                            <p class="text-xl font-bold">${wakilKetua}</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <p class="text-sm font-semibold text-indigo-800">Sekertaris</p>
                            <p class="text-xl font-bold">${sekertaris}</p>
                        </div>
                        <div class="bg-pink-50 p-4 rounded-lg md:col-span-2">
                            <p class="text-sm font-semibold text-pink-800">Bendahara</p>
                            <p class="text-xl font-bold">${bendahara}</p>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-bold text-xl mb-4 text-center">Anggota Kelas</h4>
                        ${anggotaHtml}
                    </div>
                </div>`;
            }
            if (activeTab === 'jurnalMood') {
                return renderMoodJournal();
            }
            return `<div class="text-center p-8 bg-white rounded-lg shadow-md"><h3 class="font-bold text-xl">Fitur Dalam Pengembangan</h3></div>`;
        }


        function renderClassSelection() {
            const availableClasses = allClasses
                .filter(c => c.grade === currentUserProfile.grade)
                .sort((a, b) => a.name.localeCompare(b.name));

            views.classSelection.innerHTML = `
                <div class="flex flex-col items-center justify-center min-h-full p-4">
                    <div class="w-full max-w-4xl text-center">
                        <h1 class="text-4xl font-bold mb-2">Pilih Kelas Kamu</h1>
                        <p class="text-slate-600 mb-8">Halo ${currentUserProfile.full_name}, silakan pilih kelasmu untuk melihat jadwal.</p>
                        <div id="classGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            ${availableClasses.length > 0 ? availableClasses.map(cls => `
                                <button class="select-class-btn p-4 bg-white rounded-xl shadow-md font-bold text-lg hover:bg-blue-100 transition-colors" data-id="${cls.id}">
                                    ${cls.name}
                                </button>
                            `).join('') : '<p class="col-span-full text-slate-500">Tidak ada kelas yang tersedia untuk tingkat Anda.</p>'}
                        </div>
                        <button id="selectionLogoutBtn" class="mt-8 text-slate-500 hover:text-slate-800">Logout</button>
                    </div>
                </div>
            `;
        }

        function createLessonRow(lesson = { day: 'Senin', time: '', subject: '', teacher: '' }) {
            const dayOptions = allDays.map(d => `<option value="${d}" ${lesson.day === d ? 'selected' : ''}>${d}</option>`).join('');
            return `
                <div class="lesson-row grid grid-cols-1 md:grid-cols-5 gap-2 items-center">
                    <select class="p-2 border rounded-md lesson-day">${dayOptions}</select>
                    <input type="time" class="p-2 border rounded-md lesson-time" value="${lesson.time}">
                    <input type="text" placeholder="Mata Pelajaran" class="p-2 border rounded-md lesson-subject" value="${lesson.subject}">
                    <input type="text" placeholder="Nama Guru" class="p-2 border rounded-md lesson-teacher" value="${lesson.teacher}">
                    <button type="button" class="remove-row-btn text-red-500 justify-self-center"><i class="fas fa-trash"></i></button>
                </div>
            `;
        }

        function createPicketRow(picket = { day: 'Senin', students: [] }) {
            const dayOptions = allDays.map(d => `<option value="${d}" ${picket.day === d ? 'selected' : ''}>${d}</option>`).join('');
            return `
                <div class="picket-row grid grid-cols-1 md:grid-cols-4 gap-2 items-center">
                    <select class="p-2 border rounded-md picket-day col-span-1">${dayOptions}</select>
                    <input type="text" placeholder="Nama Siswa (pisahkan dengan koma)" class="p-2 border rounded-md picket-students col-span-2" value="${picket.students.join(', ')}">
                    <button type="button" class="remove-row-btn text-red-500 justify-self-center"><i class="fas fa-trash"></i></button>
                </div>
            `;
        }

        function renderScheduleEditModal(cls) {
            document.getElementById('scheduleModalTitle').textContent = `Edit Jadwal Kelas ${cls.name}`;

            const lessonContainer = document.getElementById('lessonScheduleFormContainer');
            lessonContainer.innerHTML = (cls.lessons && cls.lessons.length > 0) ? cls.lessons.map(createLessonRow).join('') : '';
            
            const picketContainer = document.getElementById('picketScheduleFormContainer');
            picketContainer.innerHTML = (cls.picket && cls.picket.length > 0) ? cls.picket.map(createPicketRow).join('') : '';

            const organigramContainer = document.getElementById('organigramFormContainer');
            organigramContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="waliKelasInput" class="block text-sm font-medium text-slate-700">Wali Kelas</label>
                        <input type="text" id="waliKelasInput" class="mt-1 w-full p-2 border rounded-md" value="${cls.organigram?.waliKelas || ''}">
                    </div>
                    <div>
                        <label for="ketuaKelasInput" class="block text-sm font-medium text-slate-700">Ketua Kelas</label>
                        <input type="text" id="ketuaKelasInput" class="mt-1 w-full p-2 border rounded-md" value="${cls.organigram?.ketuaKelas || cls.organigram?.ketuaMurid || ''}">
                    </div>
                    <div>
                        <label for="wakilKetuaInput" class="block text-sm font-medium text-slate-700">Wakil Ketua Kelas</label>
                        <input type="text" id="wakilKetuaInput" class="mt-1 w-full p-2 border rounded-md" value="${cls.organigram?.wakilKetua || ''}">
                    </div>
                    <div>
                        <label for="sekertarisInput" class="block text-sm font-medium text-slate-700">Sekertaris</label>
                        <input type="text" id="sekertarisInput" class="mt-1 w-full p-2 border rounded-md" value="${cls.organigram?.sekertaris || ''}">
                    </div>
                    <div>
                        <label for="bendaharaInput" class="block text-sm font-medium text-slate-700">Bendahara</label>
                        <input type="text" id="bendaharaInput" class="mt-1 w-full p-2 border rounded-md" value="${cls.organigram?.bendahara || ''}">
                    </div>
                    <div class="md:col-span-2">
                        <label for="anggotaKelasInput" class="block text-sm font-medium text-slate-700">Anggota Kelas (pisahkan dengan koma)</label>
                        <textarea id="anggotaKelasInput" class="mt-1 w-full p-2 border rounded-md" rows="3">${(cls.organigram?.anggotaKelas || []).join(', ')}</textarea>
                    </div>
                </div>
            `;
        }

        async function handleDownloadTemplate() {
            showLoading(true);
            const templateLessons = [
                { NAMA_KELAS: "Contoh: 10A", HARI: "Senin", WAKTU: "07:00", MATERI_PELAJARAN: "Matematika", NAMA_GURU: "Budi S." },
                { NAMA_KELAS: "Contoh: 10A", HARI: "Senin", WAKTU: "08:30", MATERI_PELAJARAN: "Bahasa Indonesia", NAMA_GURU: "Ani W." },
                { NAMA_KELAS: "Contoh: 10B", HARI: "Selasa", WAKTU: "09:00", MATERI_PELAJARAN: "Biologi", NAMA_GURU: "Eko P." }
            ];
            const templatePicket = [
                { NAMA_KELAS: "Contoh: 10A", HARI: "Senin", DAFTAR_SISWA: "Siswa A, Siswa B, Siswa C" },
                { NAMA_KELAS: "Contoh: 10A", HARI: "Selasa", DAFTAR_SISWA: "Siswa D, Siswa E" },
                { NAMA_KELAS: "Contoh: 10B", HARI: "Rabu", DAFTAR_SISWA: "Siswa F, Siswa G, Siswa H" }
            ];
            const templateOrganigram = [
                { NAMA_KELAS: "Contoh: 10A", WALI_KELAS: "Nama Wali Kelas", KETUA_KELAS: "Nama Ketua", WAKIL_KETUA: "Nama Wakil", SEKERTARIS: "Nama Sekertaris", BENDAHARA: "Nama Bendahara", ANGGOTA_KELAS: "Anggota A, Anggota B, Anggota C" }
            ];

            const wb = XLSX.utils.book_new();
            const wsLessons = XLSX.utils.json_to_sheet(templateLessons);
            const wsPicket = XLSX.utils.json_to_sheet(templatePicket);
            const wsOrganigram = XLSX.utils.json_to_sheet(templateOrganigram);

            XLSX.utils.book_append_sheet(wb, wsLessons, "JadwalPelajaran");
            XLSX.utils.book_append_sheet(wb, wsPicket, "JadwalPiket");
            XLSX.utils.book_append_sheet(wb, wsOrganigram, "Organigram");

            XLSX.writeFile(wb, "Template_Jadwal_Clanvas.xlsx");
            showLoading(false);
            showAlert("Template berhasil diunduh. Silakan isi dan unggah kembali.", false);
        }

        async function handleExcelImport(file) {
            showLoading(true);
            try {
                const data = await file.arrayBuffer();
                const wb = XLSX.read(data);

                // Pastikan sheet yang dibutuhkan ada
                if (!wb.Sheets['JadwalPelajaran'] || !wb.Sheets['JadwalPiket'] || !wb.Sheets['Organigram']) {
                    throw new Error("Format template tidak valid. Pastikan sheet 'JadwalPelajaran', 'JadwalPiket', dan 'Organigram' ada.");
                }

                const lessonsData = XLSX.utils.sheet_to_json(wb.Sheets['JadwalPelajaran']);
                const picketData = XLSX.utils.sheet_to_json(wb.Sheets['JadwalPiket']);
                const organigramData = XLSX.utils.sheet_to_json(wb.Sheets['Organigram']);

                // Siapkan data update untuk Supabase
                const updatePromises = allClasses.map(cls => {
                    // 1. Proses Jadwal Pelajaran
                    const classLessons = lessonsData
                        .filter(r => r.NAMA_KELAS === cls.name)
                        .map(r => ({ day: r.HARI, time: r.WAKTU, subject: r.MATERI_PELAJARAN, teacher: r.NAMA_GURU }));
                    
                    // 2. Proses Jadwal Piket
                    const classPicket = picketData
                        .filter(r => r.NAMA_KELAS === cls.name)
                        .map(r => ({ day: r.HARI, students: (r.DAFTAR_SISWA || '').split(',').map(s => s.trim()).filter(s => s) }));

                    // 3. Proses Organigram
                    const classOrgData = organigramData.find(r => r.NAMA_KELAS === cls.name);
                    let classOrganigram = cls.organigram; // Pertahankan data lama jika tidak ada di Excel
                    if (classOrgData) {
                        classOrganigram = {
                            waliKelas: classOrgData.WALI_KELAS || '',
                            ketuaKelas: classOrgData.KETUA_KELAS || '',
                            wakilKetua: classOrgData.WAKIL_KETUA || '',
                            sekertaris: classOrgData.SEKERTARIS || '',
                            bendahara: classOrgData.BENDAHARA || '',
                            anggotaKelas: (classOrgData.ANGGOTA_KELAS || '').split(',').map(s => s.trim()).filter(s => s)
                        };
                    }

                    // Kembalikan promise untuk update
                    return supabase.from('classes')
                        .update({ lessons: classLessons, picket: classPicket, organigram: classOrganigram })
                        .eq('id', cls.id);
                });

                // Jalankan semua update
                await Promise.all(updatePromises);

                await loadDataFromDB(); // Muat ulang semua data
                showAlert("Semua jadwal berhasil diimpor dari Excel!", false);

            } catch (error) {
                console.error("Error importing Excel:", error);
                showAlert(`Gagal mengimpor file: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Intro animation
            setTimeout(() => {
                const storedSession = sessionStorage.getItem(SESSION_KEY);
                if (storedSession) {
                    currentUserProfile = JSON.parse(storedSession);
                    navigateBasedOnRole();
                } else {
                    showView('landing');
                }
            }, 2500);

            await initializeDB();
            
            document.getElementById('goToLoginBtn').addEventListener('click', () => showView('login'));
            document.getElementById('backToLandingBtn').addEventListener('click', () => showView('landing'));
            
            document.getElementById('loginRole').addEventListener('change', (e) => {
                document.getElementById('loginGradeContainer').style.display = e.target.value === 'Siswa' ? 'block' : 'none';
            });
            document.getElementById('newRole').addEventListener('change', (e) => {
                document.getElementById('newUserGradeContainer').style.display = e.target.value === 'Siswa' ? 'block' : 'none';
            });
            document.getElementById('editRole').addEventListener('change', (e) => {
                document.getElementById('editUserGradeContainer').style.display = e.target.value === 'Siswa' ? 'block' : 'none';
            });
            
            document.getElementById('authForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const fullName = document.getElementById('fullName').value;
                const password = document.getElementById('password').value;
                const role = document.getElementById('loginRole').value;
                const grade = document.getElementById('loginGrade').value;
                
                await loadDataFromDB();
                
                // PERBAIKAN: Logika login yang ketat, memeriksa nama, password, dan peran
                const foundUser = allUsers.find(u => {
                    const nameMatch = u.full_name.toLowerCase() === fullName.toLowerCase();
                    const passMatch = u.password === password;
                    const roleMatch = u.role === role;
                    
                    if (role === 'Siswa') {
                        // Jika login sebagai Siswa, periksa juga tingkat kelas
                        const gradeMatch = u.grade === grade;
                        return nameMatch && passMatch && roleMatch && gradeMatch;
                    } else {
                        // Jika login sebagai Admin, tingkat kelas tidak relevan
                        return nameMatch && passMatch && roleMatch;
                    }
                });
                
                if(foundUser) {
                    currentUserProfile = foundUser;
                    sessionStorage.setItem(SESSION_KEY, JSON.stringify(currentUserProfile));
                    await navigateBasedOnRole();
                } else {
                    showAlert('Nama, password, peran, atau tingkat kelas tidak cocok.');
                }
                showLoading(false);
            });
            
            document.getElementById('userAddForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const fullName = document.getElementById('newFullName').value;
                const password = document.getElementById('newPassword').value;
                const role = document.getElementById('newRole').value;
                const grade = document.getElementById('newGrade').value;

                const newUser = {
                    id: crypto.randomUUID(),
                    full_name: fullName,
                    password: password,
                    role: role,
                    grade: role === 'Siswa' ? grade : null,
                    selected_class_id: null,
                    notifications_enabled: role === 'Siswa'
                };

                const { error } = await supabase.from('users').insert([newUser]);
                
                if (error) {
                    showAlert('Gagal menambahkan pengguna: Mungkin nama sudah ada?');
                } else {
                    showAlert('Pengguna berhasil ditambahkan.', false);
                    e.target.reset();
                    closeModal();
                    await loadDataFromDB();
                    renderUserList();
                }
                showLoading(false);
            });
            
            document.getElementById('userEditForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                showLoading(true);
                const id = document.getElementById('editUserId').value;
                const fullName = document.getElementById('editFullName').value;
                const password = document.getElementById('editPassword').value;
                const role = document.getElementById('editRole').value;
                const grade = document.getElementById('editGrade').value;

                let updates = {
                    full_name: fullName,
                    role: role,
                    grade: role === 'Siswa' ? grade : null,
                };
                if (password) {
                    updates.password = password;
                }

                const { error } = await supabase.from('users').update(updates).eq('id', id);

                if (error) {
                    showAlert('Gagal memperbarui pengguna: ' + error.message);
                } else {
                    showAlert('Pengguna berhasil diperbarui.', false);
                    closeModal();
                    await loadDataFromDB();
                    renderUserList();
                }
                showLoading(false);
            });
            
            document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
                if (!itemToDelete.id || !itemToDelete.type) return;

                showLoading(true);
                let error;
                if (itemToDelete.type === 'user') {
                    const result = await supabase.from('users').delete().eq('id', itemToDelete.id);
                    error = result.error;
                }

                if (error) {
                    showAlert('Gagal menghapus: ' + error.message);
                } else {
                    showAlert(`${itemToDelete.name} berhasil dihapus.`, false);
                    await loadDataFromDB();
                    if(itemToDelete.type === 'user') renderUserList();
                }
                
                closeModal();
                itemToDelete = { type: null, id: null, name: null };
                showLoading(false);
            });

            document.getElementById('saveScheduleChangesBtn').addEventListener('click', async () => {
                if (!currentEditingClassId) return;
                showLoading(true);

                const lessons = Array.from(document.querySelectorAll('#lessonScheduleFormContainer .lesson-row')).map(row => ({
                    day: row.querySelector('.lesson-day').value,
                    time: row.querySelector('.lesson-time').value,
                    subject: row.querySelector('.lesson-subject').value,
                    teacher: row.querySelector('.lesson-teacher').value
                })).filter(l => l.subject); // Hanya simpan jika ada mata pelajaran

                const picket = Array.from(document.querySelectorAll('#picketScheduleFormContainer .picket-row')).map(row => ({
                    day: row.querySelector('.picket-day').value,
                    students: row.querySelector('.picket-students').value.split(',').map(s => s.trim()).filter(s => s)
                }));

                const organigram = {
                    waliKelas: document.getElementById('waliKelasInput').value,
                    ketuaKelas: document.getElementById('ketuaKelasInput').value, // Renamed from ketuaMurid
                    wakilKetua: document.getElementById('wakilKetuaInput').value,
                    sekertaris: document.getElementById('sekertarisInput').value,
                    bendahara: document.getElementById('bendaharaInput').value,
                    anggotaKelas: document.getElementById('anggotaKelasInput').value.split(',').map(s => s.trim()).filter(s => s) // Save as array
                };

                const { error } = await supabase.from('classes').update({ lessons, picket, organigram }).eq('id', currentEditingClassId);

                if (error) {
                    showAlert('Gagal menyimpan jadwal: ' + error.message);
                } else {
                    showAlert('Jadwal berhasil disimpan.', false);
                    closeModal();
                    await loadDataFromDB();
                }
                showLoading(false);
            });


            // Event delegation for dynamically created buttons
            document.body.addEventListener('click', async (e) => {
                const targetButton = e.target.closest('button');
                if (!targetButton) return;
                
                if (targetButton.id === 'adminLogoutBtn' || targetButton.classList.contains('logoutBtn') || targetButton.id === 'selectionLogoutBtn') {
                    handleLogout();
                }
                if (targetButton.id === 'addUserBtn') {
                    document.getElementById('userAddForm').reset();
                    showModal('userAdd');
                }
                 if (targetButton.id === 'addLessonBtn') {
                    document.getElementById('lessonScheduleFormContainer').insertAdjacentHTML('beforeend', createLessonRow());
                }
                if (targetButton.id === 'addPicketBtn') {
                    document.getElementById('picketScheduleFormContainer').insertAdjacentHTML('beforeend', createPicketRow());
                }
                if (targetButton.classList.contains('remove-row-btn')) {
                    targetButton.parentElement.remove();
                }
                if (targetButton.classList.contains('edit-user-btn')) {
                    const userId = targetButton.dataset.id;
                    const user = allUsers.find(u => u.id === userId);
                    if (user) {
                        document.getElementById('editUserId').value = user.id;
                        document.getElementById('editFullName').value = user.full_name;
                        document.getElementById('editPassword').value = '';
                        document.getElementById('editRole').value = user.role;
                        document.getElementById('editGrade').value = user.grade || '10';
                        document.getElementById('editUserGradeContainer').style.display = user.role === 'Siswa' ? 'block' : 'none';
                        showModal('userEdit');
                    }
                }
                if (targetButton.classList.contains('delete-user-btn')) {
                    itemToDelete.id = targetButton.dataset.id;
                    itemToDelete.name = targetButton.dataset.name;
                    itemToDelete.type = 'user';
                    document.getElementById('confirmTitle').textContent = 'Hapus Pengguna?';
                    document.getElementById('confirmText').textContent = `Apakah Anda yakin ingin menghapus ${itemToDelete.name}? Tindakan ini tidak dapat dibatalkan.`;
                    showModal('confirm');
                }
                 if (targetButton.classList.contains('edit-class-btn')) {
                    const classId = targetButton.dataset.id;
                    currentEditingClassId = classId;
                    const cls = allClasses.find(c => c.id === classId);
                    if (cls) {
                        renderScheduleEditModal(cls);
                        showModal('schedule');
                    }
                }
                if (targetButton.classList.contains('select-class-btn')) {
                    const classId = targetButton.dataset.id;
                    showLoading(true);
                    const { error } = await supabase.from('users').update({ selected_class_id: classId }).eq('id', currentUserProfile.id);
                    if (error) {
                        showAlert('Gagal memilih kelas: ' + error.message);
                        showLoading(false);
                    } else {
                        currentUserProfile.selected_class_id = classId;
                        sessionStorage.setItem(SESSION_KEY, JSON.stringify(currentUserProfile));
                        await navigateBasedOnRole();
                    }
                }
                 if (targetButton.classList.contains('changeClassBtn')) {
                    showLoading(true);
                    const { error } = await supabase.from('users').update({ selected_class_id: null }).eq('id', currentUserProfile.id);
                    if (error) {
                        showAlert('Gagal mengubah kelas: ' + error.message);
                        showLoading(false);
                    } else {
                        currentUserProfile.selected_class_id = null;
                        sessionStorage.setItem(SESSION_KEY, JSON.stringify(currentUserProfile));
                        await navigateBasedOnRole();
                    }
                }
                if (targetButton.classList.contains('main-tab-btn')) {
                    document.querySelectorAll('.main-tab-btn').forEach(btn => btn.classList.remove('active'));
                    targetButton.classList.add('active');
                    const cls = allClasses.find(c => c.id === currentUserProfile.selected_class_id);
                    document.getElementById('tabContentContainer').innerHTML = renderStudentTabContent(cls, targetButton.dataset.tab);
                    if (targetButton.dataset.tab === 'jurnalMood') {
                        setTimeout(drawStudentMoodChart, 0); // Panggil gambar chart setelah HTML dirender
                    }
                }
                if (targetButton.classList.contains('mood-btn')) {
                    showLoading(true);
                    const mood = targetButton.dataset.mood;
                    const today = new Date().toISOString().split('T')[0];

                    const { data: existing, error: selectError } = await supabase
                        .from('mood_logs')
                        .select('id')
                        .eq('userId', currentUserProfile.id)
                        .eq('date', today)
                        .single();

                    let dbError;
                    if (existing) {
                        const { error } = await supabase.from('mood_logs').update({ mood }).eq('id', existing.id);
                        dbError = error;
                    } else {
                        const newLog = { 
                            logId: crypto.randomUUID(), 
                            userId: currentUserProfile.id, 
                            date: today, 
                            mood 
                        };
                        const { error } = await supabase.from('mood_logs').insert(newLog);
                        dbError = error;
                    }

                    if (dbError) {
                        showAlert('Gagal menyimpan mood: ' + dbError.message);
                    } else {
                        showAlert('Mood berhasil disimpan!', false);
                        await loadDataFromDB(); // Muat ulang data
                        const cls = allClasses.find(c => c.id === currentUserProfile.selected_class_id);
                        // Render ulang tab DAN chart
                        document.getElementById('tabContentContainer').innerHTML = renderStudentTabContent(cls, 'jurnalMood');
                        setTimeout(drawStudentMoodChart, 0);
                    }
                    showLoading(false);
                }
                if (targetButton.id === 'downloadTemplateBtn') {
                    handleDownloadTemplate();
                }
                if (targetButton.id === 'uploadExcelBtn') {
                    document.getElementById('excelUploadInput').click();
                }
            });

            // Listener untuk filter admin dan upload excel
            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'moodRecapFilter') {
                    drawAdminMoodChart(e.target.value);
                }
                if (e.target.id === 'excelUploadInput') {
                    if (e.target.files && e.target.files[0]) {
                        handleExcelImport(e.target.files[0]);
                    }
                    e.target.value = null; // Reset input agar bisa upload file yang sama lagi
                }
            });
            
            // Close modals
            document.querySelectorAll('.modal-close-btn, #cancelDeleteBtn').forEach(el => {
                el.addEventListener('click', () => closeModal());
            });

             document.querySelectorAll('.fixed-modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        closeModal();
                    }
                });
            });
        });
    </script>
</body>
</html>
